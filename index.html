<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰§æœ¬å°è¯æ ‡æ³¨å·¥å…·</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f0f2f5; color: #333; }
        .header { background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 14px 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.12); }
        .header h1 { font-size: 1.3rem; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        .header-actions { display: flex; gap: 8px; }
        .btn { padding: 7px 14px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; transform: translateY(-1px); }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #219a52; transform: translateY(-1px); }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .btn-secondary { background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.2); }
        .btn-secondary:hover { background: rgba(255,255,255,0.25); }
        .btn-warning { background: #f39c12; color: white; }
        .btn-warning:hover { background: #e67e22; transform: translateY(-1px); }
        .ollama-panel { background: #34495e; padding: 15px 24px; display: none; color: white; gap: 15px; flex-wrap: wrap; }
        .ollama-panel.show { display: flex; flex-direction: column; }
        .ollama-panel label { font-size: 0.85rem; }
        .ollama-panel input, .ollama-panel select { padding: 6px 10px; border-radius: 4px; border: none; font-size: 0.85rem; }
        .ollama-panel input:focus, .ollama-panel select:focus { outline: 2px solid #3498db; }
        .main-container { display: flex; height: calc(100vh - 65px); }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; }
        .sidebar-header { padding: 16px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .sidebar-header span { font-weight: 500; color: #2c3e50; }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 10px; position: relative; }
        .dialogue-item { 
            padding: 12px 14px; border-radius: 8px; margin-bottom: 8px; cursor: grab; 
            border: 2px solid transparent; transition: all 0.2s ease; background: #fafafa; 
            position: relative; user-select: none;
        }
        .dialogue-item:hover { background: #f0f4f8; }
        .dialogue-item.active { background: #e8f4fc; border-color: #3498db; }
        .dialogue-item.dragging { 
            opacity: 0.5; transform: scale(0.98); border-style: dashed; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.15); z-index: 100;
        }
        .dialogue-item.drag-over { 
            border-color: #3498db; background: #e8f4fc; 
            box-shadow: 0 0 0 2px rgba(52,152,219,0.3);
        }
        .dialogue-item.drag-placeholder {
            border: 2px dashed #bdc3c7; background: #f8f9fa; min-height: 60px;
        }
        .dialogue-item .title { 
            font-weight: 500; color: #2c3e50; margin-bottom: 6px; 
            font-size: 0.95rem; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
        .dialogue-item .meta { font-size: 0.8rem; color: #7f8c8d; display: flex; justify-content: space-between; align-items: center; }
        .dialogue-item .delete-btn { 
            opacity: 0; padding: 4px 8px; border: none; border-radius: 4px; 
            background: #e74c3c; color: white; cursor: pointer; font-size: 0.75rem; transition: all 0.2s;
        }
        .dialogue-item:hover .delete-btn { opacity: 1; }
        .dialogue-item .delete-btn:hover { background: #c0392b; }
        
        /* æ‹–æ‹½æŒ‡ç¤ºçº¿ */
        .drag-indicator {
            position: absolute; height: 3px; 
            background: #3498db; border-radius: 2px; pointer-events: none;
            opacity: 0; transition: opacity 0.15s;
            z-index: 100;
        }
        .drag-indicator.visible { opacity: 1; }
        .editor { flex: 1; padding: 24px; overflow-y: auto; background: #f0f2f5; }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #95a5a6; }
        .empty-state h3 { margin-bottom: 8px; }
        .card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #eee; }
        .card-header h3 { font-size: 1.1rem; color: #2c3e50; }
        .mode-tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .mode-tab { padding: 10px 20px; background: #ecf0f1; border: none; cursor: pointer; border-radius: 6px; font-size: 0.9rem; transition: all 0.2s; }
        .mode-tab.active { background: #3498db; color: white; }
        .lines-section { margin-bottom: 24px; }
        .line-row { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; transition: all 0.2s; }
        .line-row:hover { background: #f0f4f8; }
        .line-row.active { background: #fff3cd; border: 1px solid #f39c12; }
        .line-row.ai-generated { background: linear-gradient(135deg, #fafbfc 0%, #f0f4f8 100%); border-left: 3px solid #9b59b6; }
        .line-row.ai-generated:hover { background: linear-gradient(135deg, #f5f7fa 0%, #e4ecf4 100%); }
        .line-num { position: relative; display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #3498db; color: white; border-radius: 50%; font-size: 0.75rem; flex-shrink: 0; cursor: pointer; transition: all 0.2s; }
        .line-num:hover { transform: scale(1.1); }
        .line-num.annotated { background: #27ae60; }
        .line-num.selected { background: #f39c12; }
        .line-num.ai-mark::after { content: ''; position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; background: #9b59b6; border: 2px solid white; border-radius: 50%; }
        .ai-tooltip { position: relative; }
        .ai-tooltip:hover::before { content: attr(data-ai-model); position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); padding: 4px 8px; background: #333; color: white; font-size: 0.7rem; border-radius: 4px; white-space: nowrap; z-index: 100; margin-bottom: 4px; }
        .ai-tooltip:hover::after { content: ''; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); border: 4px solid transparent; border-top-color: #333; margin-bottom: -4px; }
        .line-num { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: #3498db; color: white; border-radius: 50%; font-size: 0.8rem; flex-shrink: 0; cursor: pointer; transition: all 0.2s; }
        .line-num:hover { transform: scale(1.1); }
        .line-num.annotated { background: #27ae60; }
        .line-num.selected { background: #f39c12; }
        .line-inputs { flex: 1; display: flex; gap: 12px; }
        .line-inputs input { padding: 10px 14px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
        .line-inputs input:focus { outline: none; border-color: #3498db; }
        .line-inputs .speaker { width: 120px; }
        .line-inputs .content { flex: 1; resize: vertical; min-height: 40px; }
        .line-actions { display: flex; gap: 4px; align-items: center; }
        .line-btn { padding: 6px 10px; cursor: pointer; font-size: 1.1rem; opacity: 0.5; transition: all 0.2s; background: none; border: none; }
        .line-btn:hover { opacity: 1; }
        .line-btn.remove { color: #e74c3c; }
        .add-line-btn { width: 100%; padding: 14px; border: 2px dashed #ccc; background: none; cursor: pointer; border-radius: 8px; color: #7f8c8d; font-size: 0.9rem; transition: all 0.2s; }
        .add-line-btn:hover { border-color: #3498db; color: #3498db; background: #f0f8ff; }
        .scores-section { margin-bottom: 24px; }
        .scores-section h4 { font-size: 0.95rem; color: #2c3e50; margin-bottom: 16px; }
        .scores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 12px; }
        .score-card { background: #f8f9fa; padding: 16px; border-radius: 8px; }
        .score-card label { display: block; margin-bottom: 10px; font-size: 0.85rem; color: #555; font-weight: 500; }
        .score-buttons { display: flex; gap: 6px; }
        .score-buttons button { width: 32px; height: 32px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 6px; font-size: 0.85rem; transition: all 0.2s; }
        .score-buttons button:hover { border-color: #3498db; }
        .score-buttons button.active { background: #3498db; color: white; border-color: #3498db; }
        .tags-section { margin-bottom: 24px; }
        .tags-section h4 { font-size: 0.95rem; color: #2c3e50; margin-bottom: 12px; }
        .preset-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
        .preset-tag { padding: 4px 8px; border: 1px solid #e0e0e0; border-radius: 16px; background: white; cursor: pointer; font-size: 0.8rem; transition: all 0.2s; color: #555; position: relative; display: inline-flex; align-items: center; gap: 3px; }
        .preset-tag:hover { border-color: #3498db; color: #3498db; }
        .preset-tag.active { background: #3498db; color: white; border-color: #3498db; }
        .tag-close { display: none; width: 14px; height: 14px; border-radius: 50%; background: rgba(0,0,0,0.2); color: inherit; font-size: 12px; line-height: 13px; text-align: center; cursor: pointer; margin-left: 2px; }
        .preset-tag.active .tag-close { background: rgba(255,255,255,0.3); }
        .tag-close:hover { background: rgba(0,0,0,0.4) !important; }
        .preset-tag[data-custom="true"]:hover .tag-close, .preset-tag[data-custom="true"].active:hover .tag-close { display: flex; align-items: center; justify-content: center; }
        .custom-tag-input { padding: 6px 10px; border: 1px solid #e0e0e0; border-radius: 4px; flex: 1; font-size: 0.85rem; }
        .custom-tag-input:focus { outline: none; border-color: #3498db; box-shadow: 0 0 0 2px rgba(52,152,219,0.1); }
        .suggestion-section { margin-bottom: 20px; }
        .suggestion-section h4 { font-size: 0.9rem; color: #2c3e50; margin-bottom: 10px; font-weight: 500; }
        .suggestion-section textarea { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; min-height: 90px; resize: vertical; font-family: inherit; font-size: 0.9rem; background: #fafafa; }
        .suggestion-section textarea:focus { outline: none; border-color: #3498db; background: white; }
        .complete-panel { background: linear-gradient(135deg, #f8f9fa 0%, #f0f2f5 100%); padding: 18px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #e8e8e8; }
        .complete-panel h4 { font-size: 0.95rem; color: #2c3e50; margin-bottom: 10px; font-weight: 500; }
        .complete-info { background: #fff9e6; padding: 10px 14px; border-radius: 6px; margin-bottom: 14px; font-size: 0.85rem; border-left: 3px solid #f39c12; }
        .complete-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 12px; }
        .complete-row input[type="number"] { width: 60px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
        .status-panel { width: 260px; background: white; border-left: 1px solid #e8e8e8; padding: 20px; }
        .status-section { margin-bottom: 24px; }
        .status-section h4 { font-size: 0.75rem; color: #999; text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; font-weight: 600; }
        .stat-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f5f5f5; font-size: 0.85rem; color: #555; }
        .stat-item .value { font-weight: 600; color: #2c3e50; }
        .progress-bar { height: 5px; background: #f0f0f0; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .progress-bar .fill { height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71); border-radius: 3px; transition: width 0.3s ease; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.35); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal.show { display: flex; }
        .modal-content { background: white; border-radius: 12px; width: 90%; max-width: 520px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; cursor: move; background: #fafafa; border-radius: 12px 12px 0 0; }
        .modal-header h4 { font-size: 0.95rem; color: #2c3e50; font-weight: 500; }
        .modal-close { font-size: 1.4rem; cursor: pointer; color: #999; line-height: 1; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; transition: all 0.2s; }
        .modal-close:hover { color: #333; background: #f0f0f0; }
        .modal-body { padding: 20px; }
        .modal-line-preview { background: #f8f9fa; padding: 14px 18px; border-radius: 8px; margin-bottom: 20px; font-size: 0.95rem; border-left: 4px solid #3498db; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee; }
        .hidden { display: none !important; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .loading-overlay.show { display: flex; }
        .loading-box { background: white; padding: 30px 40px; border-radius: 10px; text-align: center; }
        .spinner { width: 40px; height: 40px; border: 3px solid #f3f3f3; border-top: 3px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 12px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Stats Report */
        .stats-report { margin-top: 20px; padding-top: 16px; border-top: 1px solid #eee; }
        .stats-report h4 { font-size: 0.85rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px; }
        .avg-scores { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
        .avg-score-item { display: flex; justify-content: space-between; font-size: 0.8rem; padding: 6px 0; border-bottom: 1px solid #f0f0f0; }
        .avg-score-item .label { color: #666; }
        .avg-score-item .value { font-weight: 600; color: #2c3e50; }
        .avg-score-item .value.high { color: #27ae60; }
        .avg-score-item .value.medium { color: #f39c12; }
        .avg-score-item .value.low { color: #e74c3c; }
        .tag-stats { margin-top: 12px; }
        .tag-stat-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 0.8rem; }
        .tag-stat-item .tag-name { color: #3498db; background: #e8f4fc; padding: 3px 8px; border-radius: 12px; }
        .tag-stat-item .tag-count { font-weight: 600; color: #2c3e50; }
        .no-stats { font-size: 0.85rem; color: #95a5a6; text-align: center; padding: 20px 0; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“ å‰§æœ¬å°è¯æ ‡æ³¨å·¥å…·</h1>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="togglePanel()">Ollamaè®¾ç½®</button>
            <button class="btn btn-secondary" onclick="saveToFile()">ğŸ’¾ å¦å­˜åˆ°æ¡Œé¢</button>
            <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“‚ å¯¼å…¥JSON</button>
            <button class="btn btn-warning" onclick="document.getElementById('mergeInput').click()">ğŸ”€ åˆå¹¶JSON</button>
            <button class="btn btn-success" onclick="exportData()">å¯¼å‡ºJSON</button>
        </div>
    </div>
    
    <input type="file" id="fileInput" accept=".json" style="display:none" onchange="loadFromFile(event)" title="é€‰æ‹©JSONæ–‡ä»¶å¯¼å…¥æ•°æ®">
    <input type="file" id="mergeInput" accept=".json" style="display:none" onchange="loadFromFile(event, true)" title="åˆå¹¶åˆ°ç°æœ‰æ•°æ®">
    
    <div class="ollama-panel" id="ollamaPanel">
        <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
            <div>
                <label title="é€‰æ‹©APIç±»å‹" style="font-size:0.85rem;display:block;margin-bottom:4px;">APIç±»å‹</label>
                <select id="apiType" title="é€‰æ‹©APIç±»å‹" onchange="onApiTypeChange()" style="padding:6px 10px;border:1px solid #ddd;border-radius:4px;">
                    <option value="ollama">Ollama (æœ¬åœ°)</option>
                    <option value="openai">OpenAI</option>
                    <option value="claude">Claude</option>
                    <option value="deepseek">DeepSeek</option>
                    <option value="qwen">é€šä¹‰åƒé—®</option>
                    <option value="zhipu">æ™ºè°±AI</option>
                    <option value="minimax">MiniMax</option>
                </select>
            </div>
            <div id="apiKeyContainer" style="flex:1;min-width:200px;display:none;">
                <label title="API Key" style="font-size:0.85rem;display:block;margin-bottom:4px;">API Key</label>
                <input type="password" id="apiKey" placeholder="è¾“å…¥API Key" onchange="saveApiKey()" style="width:100%;padding:6px 10px;border:1px solid #ddd;border-radius:4px;">
            </div>
            <div id="apiUrlContainer" style="display:none;flex:1;min-width:200px;">
                <label title="APIåœ°å€" style="font-size:0.85rem;display:block;margin-bottom:4px;">APIåœ°å€</label>
                <input type="text" id="apiUrl" placeholder="https://api..." style="width:100%;padding:6px 10px;border:1px solid #ddd;border-radius:4px;">
            </div>
        </div>
        
        <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;">
            <div id="modelSelectContainer" style="flex:1;min-width:150px;">
                <label title="é€‰æ‹©æ¨¡å‹" style="font-size:0.85rem;display:block;margin-bottom:4px;">æ¨¡å‹</label>
                <select id="ollamaModel" title="é€‰æ‹©AIæ¨¡å‹" style="width:100%;padding:6px 10px;border:1px solid #ddd;border-radius:4px;">
                    <option value="">åŠ è½½ä¸­...</option>
                </select>
            </div>
            <div id="ollamaUrlContainer" style="flex:1;min-width:200px;">
                <label title="Ollamaåœ°å€" style="font-size:0.85rem;display:block;margin-bottom:4px;">Ollamaåœ°å€</label>
                <input type="text" id="ollamaUrl" value="http://localhost:11434" placeholder="http://localhost:11434" style="width:100%;padding:6px 10px;border:1px solid #ddd;border-radius:4px;">
            </div>
            <button class="btn btn-secondary" onclick="testApi()" id="testApiBtn">æµ‹è¯•è¿æ¥</button>
            <button class="btn btn-secondary" onclick="refreshModels()" id="refreshOllamaBtn">åˆ·æ–°æ¨¡å‹</button>
        </div>
        
        <div id="apiTip" style="margin-top:10px;font-size:0.8rem;color:#666;">
            ğŸ’¡ ä½¿ç”¨Ollamaæ— éœ€API Keyï¼Œéœ€æœ¬åœ°å®‰è£…Ollama
        </div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <div class="sidebar-header">
                <span>å¯¹è¯åˆ—è¡¨</span>
                <button class="btn btn-primary" onclick="addDialogue()">+ æ–°å¢</button>
            </div>
            <div class="sidebar-list" id="dialogueList"></div>
        </div>
        
        <div class="editor" id="editor">
            <div class="empty-state" id="emptyState">
                <h3>é€‰æ‹©æˆ–åˆ›å»ºå¯¹è¯</h3>
                <p>ç‚¹å‡»å·¦ä¾§å¯¹è¯å¼€å§‹æ ‡æ³¨</p>
            </div>
            
            <div class="card hidden" id="editCard">
                <div class="mode-tabs">
                    <button class="mode-tab active" id="tabAnno" onclick="switchMode('anno')">ğŸ“ æ ‡æ³¨æ¨¡å¼</button>
                    <button class="mode-tab" id="tabComplete" onclick="switchMode('complete')">âœ¨ AIè¡¥å…¨</button>
                </div>
                
                <div class="card-header">
                    <h3>å¯¹è¯ #<span id="dialogueIndex">1</span></h3>
                    <div>
                        <button class="btn btn-danger" onclick="deleteDialogue()">åˆ é™¤</button>
                        <button class="btn btn-primary" id="saveBtn" onclick="saveDialogue()">ä¿å­˜</button>
                    </div>
                </div>
                
                <div id="annoMode">
                    <div class="lines-section" id="linesContainer"></div>
                    <button class="add-line-btn" onclick="addLine()">+ æ·»åŠ å°è¯</button>
                    
                    <div class="scores-section">
                        <h4>è¯„åˆ† (0-5)</h4>
                        <div class="scores-grid">
                            <div class="score-card"><label>å‰§æƒ…è¿è´¯æ€§</label><div class="score-buttons" id="sb1"></div></div>
                            <div class="score-card"><label>è§’è‰²ä¸€è‡´æ€§</label><div class="score-buttons" id="sb2"></div></div>
                            <div class="score-card"><label>å°è¯è‡ªç„¶åº¦</label><div class="score-buttons" id="sb3"></div></div>
                            <div class="score-card"><label>æƒ…æ„Ÿè¡¨è¾¾</label><div class="score-buttons" id="sb4"></div></div>
                            <div class="score-card"><label>æ¸¸æˆç›¸å…³åº¦</label><div class="score-buttons" id="sb5"></div></div>
                            <div class="score-card"><label>é•¿åº¦åˆé€‚åº¦</label><div class="score-buttons" id="sb6"></div></div>
                        </div>
                    </div>
                    
                    <div class="tags-section">
                        <h4>æ ‡ç­¾</h4>
                        <div class="preset-tags" id="presetTags">
                            <button class="preset-tag" data-t="æƒ…æ„Ÿå†²çª" onclick="toggleTag(this)">æƒ…æ„Ÿå†²çª</button>
                            <button class="preset-tag" data-t="è§’è‰²æˆé•¿" onclick="toggleTag(this)">è§’è‰²æˆé•¿</button>
                            <button class="preset-tag" data-t="ä¼ç¬”é“ºå«" onclick="toggleTag(this)">ä¼ç¬”é“ºå«</button>
                            <button class="preset-tag" data-t="å¹½é»˜" onclick="toggleTag(this)">å¹½é»˜</button>
                            <button class="preset-tag" data-t="ç´§å¼ " onclick="toggleTag(this)">ç´§å¼ </button>
                            <button class="preset-tag" data-t="åè½¬" onclick="toggleTag(this)">åè½¬</button>
                        </div>
                        <div style="display:flex;gap:8px;margin-top:8px;">
                            <input type="text" id="customTagInput" class="custom-tag-input" placeholder="æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ï¼ŒæŒ‰Enterç¡®è®¤">
                            <button class="btn btn-secondary" onclick="addCustomTag()" style="padding:6px 12px;">+</button>
                        </div>
                    </div>
                    
                    <div class="suggestion-section">
                        <h4>ä¿®æ”¹å»ºè®®æˆ–ç¤ºä¾‹</h4>
                        <textarea id="suggestionText" placeholder="è¾“å…¥ä¿®æ”¹å»ºè®®æˆ–å‚è€ƒç¤ºä¾‹"></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="aiSuggest()" style="margin-top:10px">ğŸ¤– AIç”Ÿæˆå»ºè®®</button>
                </div>
                
                <div id="completeMode" class="hidden">
                    <div class="complete-panel">
                        <h4>ğŸ’¡ AIè¡¥å…¨å¯¹è¯</h4>
                        <div class="complete-info">
                            <strong>é€‰ä¸­è¡Œï¼š</strong><span id="selectedInfo">æ— ï¼ˆå°†åœ¨æœ«å°¾ç»­å†™ï¼‰</span>
                        </div>
                        <div class="complete-row">
                            <label>æ’å…¥è¡Œæ•°ï¼š<input type="number" id="insertCount" value="1" min="1" max="10"></label>
                            <button class="btn btn-warning" onclick="aiComplete()">ğŸš€ AIè¡¥å…¨å¹¶æ’å…¥</button>
                            <button class="btn btn-secondary" onclick="clearAiLines()" style="margin-left:8px">ğŸ—‘ï¸ æ¸…é™¤AIå°è¯</button>
                        </div>
                    </div>
                    <div id="completeResult"></div>
                </div>
            </div>
        </div>
        
        <div class="status-panel">
            <div class="status-section">
                <h4>ç»Ÿè®¡</h4>
                <div class="stat-item"><span>æ€»å¯¹è¯æ•°</span><span class="value" id="totalCount">0</span></div>
                <div class="stat-item"><span>å·²æ ‡æ³¨</span><span class="value" id="doneCount">0</span></div>
                <div class="progress-bar"><div class="fill" id="progressFill" style="width:0%"></div></div>
            </div>
            
            <!-- ç»Ÿè®¡æŠ¥è¡¨ -->
            <div class="stats-report" id="statsReport">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h4>ğŸ“Š æ•°æ®åˆ†æ</h4>
                    <button onclick="updateStats()" style="padding:4px 8px;border:1px solid #ddd;background:white;border-radius:4px;cursor:pointer;" title="åˆ·æ–°ç»Ÿè®¡">ğŸ”„</button>
                </div>
                <div id="statsContent">
                    <div class="no-stats">æš‚æ— æ ‡æ³¨æ•°æ®</div>
                </div>
            </div>
            
            <div class="status-section" style="margin-top:auto">
                <button class="btn btn-secondary" style="width:100%;margin-bottom:8px" onclick="copyDialogue()">å¤åˆ¶å½“å‰å¯¹è¯</button>
                <button class="btn btn-secondary" style="width:100%" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
            </div>
        </div>
    </div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-box">
            <div class="spinner"></div>
            <p id="loadingText">å¤„ç†ä¸­...</p>
        </div>
    </div>
    
    <div class="modal" id="lineModal">
        <div class="modal-content" id="modalContent">
            <div class="modal-header" id="modalHeader">
                <h4>ğŸ“ å•å¥æ ‡æ³¨ - ç¬¬ <span id="modalLineNum">1</span> å¥</h4>
                <span class="modal-close" onclick="closeLineModal()">Ã—</span>
            </div>
            <div class="modal-body">
                <div class="modal-line-preview" id="modalLinePreview">è§’è‰²: å°è¯å†…å®¹...</div>
                
                <div class="scores-section">
                    <h4>è¯„åˆ† (0-5)</h4>
                    <div class="scores-grid">
                        <div class="score-card"><label>å‰§æƒ…è¿è´¯æ€§</label><div class="score-buttons" id="lsb1"></div></div>
                        <div class="score-card"><label>è§’è‰²ä¸€è‡´æ€§</label><div class="score-buttons" id="lsb2"></div></div>
                        <div class="score-card"><label>å°è¯è‡ªç„¶åº¦</label><div class="score-buttons" id="lsb3"></div></div>
                        <div class="score-card"><label>æƒ…æ„Ÿè¡¨è¾¾</label><div class="score-buttons" id="lsb4"></div></div>
                        <div class="score-card"><label>æ¸¸æˆç›¸å…³åº¦</label><div class="score-buttons" id="lsb5"></div></div>
                        <div class="score-card"><label>é•¿åº¦åˆé€‚åº¦</label><div class="score-buttons" id="lsb6"></div></div>
                    </div>
                </div>
                
                <div class="tags-section">
                    <h4>æ ‡ç­¾</h4>
                    <div class="preset-tags" id="modalPresetTags">
                        <button class="preset-tag" data-t="æƒ…æ„Ÿå†²çª" onclick="toggleTag(this)">æƒ…æ„Ÿå†²çª</button>
                        <button class="preset-tag" data-t="è§’è‰²æˆé•¿" onclick="toggleTag(this)">è§’è‰²æˆé•¿</button>
                        <button class="preset-tag" data-t="ä¼ç¬”é“ºå«" onclick="toggleTag(this)">ä¼ç¬”é“ºå«</button>
                        <button class="preset-tag" data-t="å¹½é»˜" onclick="toggleTag(this)">å¹½é»˜</button>
                        <button class="preset-tag" data-t="ç´§å¼ " onclick="toggleTag(this)">ç´§å¼ </button>
                        <button class="preset-tag" data-t="åè½¬" onclick="toggleTag(this)">åè½¬</button>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <input type="text" id="modalCustomTagInput" class="custom-tag-input" placeholder="æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ï¼ŒæŒ‰Enterç¡®è®¤">
                        <button class="btn btn-secondary" onclick="addModalCustomTag()" style="padding:6px 12px;">+</button>
                    </div>
                </div>
                
                <div class="suggestion-section">
                    <h4>ä¿®æ”¹å»ºè®®æˆ–ç¤ºä¾‹</h4>
                    <textarea id="lineSuggestion" placeholder="è¾“å…¥ä¿®æ”¹å»ºè®®æˆ–å‚è€ƒç¤ºä¾‹"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="closeLineModal()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveLineAnnotation()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        var dialogues = [];
        var curIdx = -1;
        var curMode = 'anno';
        var selectedLine = -1;
        var currentLineAnno = null;
        var aiSuggestion = '';
        
        function load() {
            var d = localStorage.getItem('d_data');
            if (d) {
                try {
                    dialogues = JSON.parse(d);
                } catch(e) {
                    console.log('è§£ælocalStorageæ•°æ®å¤±è´¥:', e.message);
                }
            }
            var s = localStorage.getItem('d_ollama');
            if (s) {
                try {
                    var o = JSON.parse(s);
                    document.getElementById('ollamaUrl').value = o.url || 'http://localhost:11434';
                    document.getElementById('ollamaModel').value = o.model || 'mistral:7b';
                    document.getElementById('apiType').value = o.apiType || 'ollama';
                    document.getElementById('apiKey').value = o.apiKey || '';
                    document.getElementById('apiUrl').value = o.apiUrl || '';
                } catch(e) {}
            }
            renderDialogueList();
            updateStats();
            setupScoreButtons();
            setupPresetTags();
            setupModalDrag();
            setupDragDropImport();
            setupLineClick(); // å°è¯è¡Œç‚¹å‡»äº‹ä»¶
            setTimeout(onApiTypeChange, 100); // å»¶è¿Ÿåˆå§‹åŒ–APIé¢æ¿ï¼Œç¡®ä¿DOMå·²å°±ç»ª
        }
        
        // å°è¯è¡Œç‚¹å‡»äº‹ä»¶ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
        function setupLineClick() {
            var container = document.getElementById('linesContainer');
            container.onclick = function(e) {
                var row = e.target.closest('.line-row');
                if (!row) return;
                // æ’é™¤æŒ‰é’®å’Œè¾“å…¥æ¡†çš„ç‚¹å‡»
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
                var idx = parseInt(row.getAttribute('data-idx'));
                if (!isNaN(idx)) {
                    selectLine(idx);
                }
            };
        }
        
        // APIç±»å‹åˆ‡æ¢
        function onApiTypeChange() {
            var apiType = document.getElementById('apiType').value;
            var keyContainer = document.getElementById('apiKeyContainer');
            var urlContainer = document.getElementById('apiUrlContainer');
            var ollamaUrlContainer = document.getElementById('ollamaUrlContainer');
            var modelSelectContainer = document.getElementById('modelSelectContainer');
            var tip = document.getElementById('apiTip');
            var testBtn = document.getElementById('testApiBtn');
            var refreshBtn = document.getElementById('refreshOllamaBtn');
            var select = document.getElementById('ollamaModel');
            var ollamaUrl = document.getElementById('ollamaUrl');
            
            // ä¿å­˜å½“å‰è®¾ç½®
            try {
                var s = localStorage.getItem('d_ollama');
                var o = s ? JSON.parse(s) : {};
                o.apiType = apiType;
                o.apiUrl = document.getElementById('apiUrl').value;
                localStorage.setItem('d_ollama', JSON.stringify(o));
            } catch(e) {}
            
            // éšè—æ‰€æœ‰é¢å¤–è¾“å…¥æ¡†
            keyContainer.style.display = 'none';
            urlContainer.style.display = 'none';
            ollamaUrlContainer.style.display = 'none';
            
            switch(apiType) {
                case 'ollama':
                    ollamaUrlContainer.style.display = 'block';
                    refreshBtn.style.display = 'inline-block';
                    testBtn.textContent = 'æµ‹è¯•è¿æ¥';
                    tip.innerHTML = 'ğŸ’¡ ä½¿ç”¨Ollamaæ— éœ€API Keyï¼Œéœ€æœ¬åœ°å®‰è£…Ollama';
                    refreshModels();
                    break;
                case 'openai':
                    keyContainer.style.display = 'block';
                    urlContainer.style.display = 'block';
                    document.getElementById('apiUrl').placeholder = 'https://api.openai.com/v1';
                    urlContainer.querySelector('label').textContent = 'APIåœ°å€';
                    refreshBtn.style.display = 'none';
                    testBtn.textContent = 'æµ‹è¯•è¿æ¥';
                    tip.innerHTML = 'ğŸ’¡ OpenAI API Keyæ ¼å¼: sk-...<br>æ¨¡å‹: gpt-4o, gpt-4-turbo, gpt-3.5-turbo';
                    loadOpenAIModels();
                    break;
                case 'claude':
                    keyContainer.style.display = 'block';
                    urlContainer.style.display = 'block';
                    document.getElementById('apiUrl').placeholder = 'https://api.anthropic.com/v1';
                    urlContainer.querySelector('label').textContent = 'APIåœ°å€';
                    refreshBtn.style.display = 'none';
                    testBtn.textContent = 'æµ‹è¯•è¿æ¥';
                    tip.innerHTML = 'ğŸ’¡ Claude API Key<br>æ¨¡å‹: claude-sonnet-4-20250514, claude-opus-4';
                    loadClaudeModels();
                    break;
                case 'deepseek':
                    keyContainer.style.display = 'block';
                    urlContainer.style.display = 'block';
                    document.getElementById('apiUrl').placeholder = 'https://api.deepseek.com/chat/completions';
                    urlContainer.querySelector('label').textContent = 'APIåœ°å€';
                    refreshBtn.style.display = 'none';
                    testBtn.textContent = 'æµ‹è¯•è¿æ¥';
                    tip.innerHTML = 'ğŸ’¡ DeepSeek API Key<br>æ¨¡å‹: deepseek-chat';
                    loadDeepSeekModels();
                    break;
                case 'qwen':
                    keyContainer.style.display = 'block';
                    urlContainer.style.display = 'block';
                    document.getElementById('apiUrl').placeholder = 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation';
                    urlContainer.querySelector('label').textContent = 'APIåœ°å€';
                    refreshBtn.style.display = 'none';
                    testBtn.textContent = 'æµ‹è¯•è¿æ¥';
                    tip.innerHTML = 'ğŸ’¡ é˜¿é‡Œé€šä¹‰åƒé—®API DashScope Key<br>æ¨¡å‹: qwen-plus, qwen-turbo, qwen-max';
                    loadQwenModels();
                    break;
                case 'zhipu':
                    keyContainer.style.display = 'block';
                    urlContainer.style.display = 'block';
                    document.getElementById('apiUrl').placeholder = 'https://open.bigmodel.cn/api/paas/v4/chat/completions';
                    urlContainer.querySelector('label').textContent = 'APIåœ°å€';
                    refreshBtn.style.display = 'none';
                    testBtn.textContent = 'æµ‹è¯•è¿æ¥';
                    tip.innerHTML = 'ğŸ’¡ æ™ºè°±AI API Key<br>æ¨¡å‹: glm-4, glm-4-plus, glm-3-turbo';
                    loadZhipuModels();
                    break;
                case 'minimax':
                    keyContainer.style.display = 'block';
                    urlContainer.style.display = 'block';
                    document.getElementById('apiUrl').placeholder = 'https://api.minimax.chat/v1/text/chatcompletion_v2';
                    urlContainer.querySelector('label').textContent = 'APIåœ°å€';
                    refreshBtn.style.display = 'none';
                    testBtn.textContent = 'æµ‹è¯•è¿æ¥';
                    tip.innerHTML = 'ğŸ’¡ MiniMax API Keyï¼ˆæ ¼å¼: Bearer xxxxï¼‰<br>æ¨¡å‹: abab6.5s-chat, abab6.5-chat, abab5.5s-chat';
                    loadMiniMaxModels();
                    break;
            }
        }
        
        // åŠ è½½å„APIçš„æ¨¡å‹åˆ—è¡¨
        function loadOpenAIModels() {
            var select = document.getElementById('ollamaModel');
            var models = ['gpt-4o', 'gpt-4o-mini', 'gpt-4-turbo', 'gpt-4', 'gpt-3.5-turbo'];
            select.innerHTML = models.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('');
        }
        
        function loadClaudeModels() {
            var select = document.getElementById('ollamaModel');
            var models = ['claude-sonnet-4-20250514', 'claude-opus-4', 'claude-sonnet-3-20250514', 'claude-haiku-3-20250514'];
            select.innerHTML = models.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('');
        }
        
        function loadDeepSeekModels() {
            var select = document.getElementById('ollamaModel');
            var models = ['deepseek-chat', 'deepseek-reasoner'];
            select.innerHTML = models.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('');
        }
        
        function loadQwenModels() {
            var select = document.getElementById('ollamaModel');
            var models = ['qwen-plus', 'qwen-turbo', 'qwen-max', 'qwen-long'];
            select.innerHTML = models.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('');
        }
        
        function loadZhipuModels() {
            var select = document.getElementById('ollamaModel');
            var models = ['glm-4', 'glm-4-plus', 'glm-4v', 'glm-3-turbo'];
            select.innerHTML = models.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('');
        }
        
        function loadMiniMaxModels() {
            var select = document.getElementById('ollamaModel');
            var models = ['abab6.5s-chat', 'abab6.5-chat', 'abab5.5s-chat'];
            select.innerHTML = models.map(function(m) { return '<option value="' + m + '">' + m + '</option>'; }).join('');
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testApi() {
            var apiType = document.getElementById('apiType').value;
            var url, apiKey;
            
            try {
                if (apiType === 'ollama') {
                    url = document.getElementById('ollamaUrl').value;
                    var r = await fetch(url + '/api/tags');
                    if (r.ok) { alert('âœ“ Ollamaè¿æ¥æˆåŠŸ'); } else { alert('âœ— è¿æ¥å¤±è´¥'); }
                } else {
                    apiKey = document.getElementById('apiKey').value;
                    if (!apiKey) { alert('è¯·è¾“å…¥API Key'); return; }
                    url = document.getElementById('apiUrl').value || getDefaultApiUrl(apiType);
                    
                    var body = getApiRequestBody(apiType, 'Hello', 'gpt-3.5-turbo');
                    var headers = getApiHeaders(apiType, apiKey);
                    
                    var r = await fetch(url, { method: 'POST', headers: headers, body: JSON.stringify(body) });
                    if (r.ok || r.status === 400) { alert('âœ“ APIè¿æ¥æˆåŠŸ'); } else { alert('âœ— è¿æ¥å¤±è´¥: ' + r.status); }
                }
            } catch(e) { alert('è¿æ¥å¤±è´¥: ' + e.message); }
        }
        
        function getDefaultApiUrl(apiType) {
            var urls = {
                'openai': 'https://api.openai.com/v1/chat/completions',
                'claude': 'https://api.anthropic.com/v1/messages',
                'deepseek': 'https://api.deepseek.com/chat/completions',
                'qwen': 'https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation',
                'zhipu': 'https://open.bigmodel.cn/api/paas/v4/chat/completions',
                'minimax': 'https://api.minimax.chat/v1/text/chatcompletion_v2'
            };
            return urls[apiType] || '';
        }
        
        function getApiHeaders(apiType, apiKey) {
            var headers = { 'Content-Type': 'application/json' };
            if (apiType === 'openai' || apiType === 'deepseek' || apiType === 'zhipu') {
                headers['Authorization'] = 'Bearer ' + apiKey;
            } else if (apiType === 'claude') {
                headers['x-api-key'] = apiKey;
                headers['anthropic-version'] = '2023-06-01';
            } else if (apiType === 'qwen' || apiType === 'minimax') {
                headers['Authorization'] = 'Bearer ' + apiKey;
            }
            return headers;
        }
        
        function getApiRequestBody(apiType, prompt, model) {
            if (apiType === 'openai' || apiType === 'deepseek' || apiType === 'zhipu' || apiType === 'minimax') {
                return { model: model, messages: [{ role: 'user', content: prompt }], max_tokens: 500 };
            } else if (apiType === 'claude') {
                return { model: model, messages: [{ role: 'user', content: prompt }], max_tokens: 500 };
            } else if (apiType === 'qwen') {
                return { model: model, input: { prompt: prompt }, parameters: { max_tokens: 500 } };
            }
            return {};
        }
        
        function getApiResponseText(apiType, data) {
            if (apiType === 'openai' || apiType === 'deepseek' || apiType === 'zhipu' || apiType === 'minimax') {
                if (!data.choices || data.choices.length === 0) return '';
                return data.choices[0].message?.content || '';
            } else if (apiType === 'claude') {
                if (!data.content || data.content.length === 0) return '';
                return data.content[0].text || '';
            } else if (apiType === 'qwen') {
                if (!data.output) return '';
                return data.output.text || '';
            }
            return '';
        }
        
        // ç»Ÿä¸€çš„AIè¯·æ±‚å‡½æ•°
        async function callAi(prompt) {
            var apiType = document.getElementById('apiType').value;
            var model = document.getElementById('ollamaModel').value;
            var url, headers, body;
            
            if (apiType === 'ollama') {
                url = document.getElementById('ollamaUrl').value + '/api/generate';
                headers = { 'Content-Type': 'application/json' };
                body = JSON.stringify({ model: model, prompt: prompt, stream: false });
            } else {
                var apiKey = document.getElementById('apiKey').value;
                url = document.getElementById('apiUrl').value || getDefaultApiUrl(apiType);
                headers = getApiHeaders(apiType, apiKey);
                body = JSON.stringify(getApiRequestBody(apiType, prompt, model));
            }
            
            console.log('APIè¯·æ±‚:', { url: url, apiType: apiType, model: model });
            
            var r = await fetch(url, { method: 'POST', headers: headers, body: body });
            console.log('APIå“åº”çŠ¶æ€:', r.status, r.statusText);
            
            if (!r.ok) {
                var errText = await r.text();
                console.error('APIé”™è¯¯å“åº”:', errText);
                throw new Error('APIè¯·æ±‚å¤±è´¥: ' + r.status + ' ' + r.statusText);
            }
            var data = await r.json();
            console.log('APIå“åº”æ•°æ®:', JSON.stringify(data).substring(0, 500));
            
            if (apiType === 'ollama') {
                return data.response || data.output || '';
            } else {
                return getApiResponseText(apiType, data);
            }
        }
        
        // åˆ·æ–°Ollamaæ¨¡å‹åˆ—è¡¨
        async function refreshModels() {
            var url = document.getElementById('ollamaUrl').value;
            var select = document.getElementById('ollamaModel');
            var savedModel = select.value;
            
            try {
                var r = await fetch(url + '/api/tags');
                if (!r.ok) throw new Error('è¿æ¥å¤±è´¥');
                var data = await r.json();
                var models = data.models || [];
                
                select.innerHTML = '';
                if (models.length === 0) {
                    select.innerHTML = '<option value="">æœªæ‰¾åˆ°æ¨¡å‹</option>';
                } else {
                    models.forEach(function(m) {
                        var opt = document.createElement('option');
                        opt.value = m.name;
                        opt.textContent = m.name + ' (' + (m.size ? formatSize(m.size) : '?') + ')';
                        select.appendChild(opt);
                    });
                    // å°è¯•æ¢å¤ä¹‹å‰é€‰æ‹©çš„æ¨¡å‹
                    if (savedModel) {
                        var found = Array.from(select.options).find(function(o) { return o.value === savedModel; });
                        if (found) found.selected = true;
                    }
                    // å¦‚æœåªæœ‰ä¸€ä¸ªæ¨¡å‹ï¼Œè‡ªåŠ¨é€‰ä¸­
                    if (models.length === 1) select.selectedIndex = 0;
                }
            } catch(e) {
                select.innerHTML = '<option value="">æ— æ³•è·å–æ¨¡å‹åˆ—è¡¨</option>';
                console.log('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', e.message);
            }
        }
        
        function formatSize(bytes) {
            if (!bytes) return '?';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024*1024) return (bytes/1024).toFixed(1) + ' KB';
            if (bytes < 1024*1024*1024) return (bytes/(1024*1024)).toFixed(1) + ' MB';
            return (bytes/(1024*1024*1024)).toFixed(1) + ' GB';
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾
        function addCustomTag() {
            var input = document.getElementById('customTagInput');
            var tag = input.value.trim();
            if (!tag) return;
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            var container = document.getElementById('presetTags');
            var existing = container.querySelector('[data-t="' + tag + '"]');
            if (existing) {
                existing.classList.add('active');
                input.value = '';
                return;
            }
            
            // æ·»åŠ æ–°æ ‡ç­¾ï¼ˆç»Ÿä¸€ç»“æ„ï¼‰
            var btn = document.createElement('button');
            btn.className = 'preset-tag active';
            btn.dataset.t = tag;
            btn.dataset.custom = 'true';
            btn.onclick = function() { toggleTag(this); };
            btn.innerHTML = tag + '<span class="tag-close" onclick="event.stopPropagation();removeCustomTag(this.parentElement)">Ã—</span>';
            container.appendChild(btn);
            input.value = '';
        }
        
        // åˆ é™¤è‡ªå®šä¹‰æ ‡ç­¾
        function removeCustomTag(el) {
            var tagName = el.dataset.t;
            if (confirm('åˆ é™¤æ ‡ç­¾ "' + tagName + '"ï¼Ÿ')) {
                el.remove();
                updateStats();
            }
        }
        
        // æ·»åŠ è‡ªå®šä¹‰æ ‡ç­¾ï¼ˆå¼¹çª—ç”¨ï¼‰
        function addModalCustomTag() {
            var input = document.getElementById('modalCustomTagInput');
            var tag = input.value.trim();
            if (!tag) return;
            
            var container = document.getElementById('modalPresetTags');
            var existing = container.querySelector('[data-t="' + tag + '"]');
            if (existing) {
                existing.classList.add('active');
                input.value = '';
                return;
            }
            
            var btn = document.createElement('button');
            btn.className = 'preset-tag active';
            btn.dataset.t = tag;
            btn.dataset.custom = 'true';
            btn.onclick = function() { toggleTag(this); };
            btn.innerHTML = tag + '<span class="tag-close" onclick="event.stopPropagation();removeModalCustomTag(this.parentElement)">Ã—</span>';
            container.appendChild(btn);
            input.value = '';
        }
        
        // åˆ é™¤å¼¹çª—ä¸­çš„è‡ªå®šä¹‰æ ‡ç­¾
        function removeModalCustomTag(el) {
            var tagName = el.dataset.t;
            el.remove();
        }
        
        // æ‹–æ‹½å¯¼å…¥ JSON æ–‡ä»¶
        function setupDragDropImport() {
            var dropZone = document.body;
            dropZone.ondragover = function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            };
            dropZone.ondrop = function(e) {
                e.preventDefault();
                var files = e.dataTransfer.files;
                if (files.length > 0 && files[0].name.endsWith('.json')) {
                    var reader = new FileReader();
                    reader.onload = function(evt) {
                        try {
                            var data = JSON.parse(evt.target.result);
                            if (data.dialogues && confirm('å¯¼å…¥ ' + data.dialogues.length + ' æ¡å¯¹è¯ï¼Ÿ\nå½“å‰æ•°æ®å°†è¢«æ›¿æ¢ã€‚')) {
                                dialogues = data.dialogues;
                                curIdx = -1;
                                renderDialogueList();
                                renderEditor();
                                updateStats();
                                saveToStorage();
                                alert('âœ“ å¯¼å…¥æˆåŠŸï¼');
                            }
                        } catch(err) {
                            alert('è§£æå¤±è´¥: ' + err.message);
                        }
                    };
                    reader.readAsText(files[0]);
                } else {
                    alert('è¯·æ‹–å…¥ JSON æ–‡ä»¶');
                }
            };
        }
        
        // ä¿å­˜API Keyè®¾ç½®
        function saveApiKey() {
            try {
                var s = localStorage.getItem('d_ollama');
                var o = s ? JSON.parse(s) : {};
                o.apiKey = document.getElementById('apiKey').value;
                localStorage.setItem('d_ollama', JSON.stringify(o));
                console.log('API Keyå·²ä¿å­˜');
            } catch(e) {
                console.error('ä¿å­˜API Keyå¤±è´¥:', e);
            }
        }
        
        function saveToStorage() {
            try {
                localStorage.setItem('d_data', JSON.stringify(dialogues));
                localStorage.setItem('d_ollama', JSON.stringify({ 
                    url: document.getElementById('ollamaUrl').value, 
                    model: document.getElementById('ollamaModel').value,
                    apiType: document.getElementById('apiType').value,
                    apiKey: document.getElementById('apiKey').value,
                    apiUrl: document.getElementById('apiUrl').value
                }));
                localStorage.removeItem('d_unsaved');
                console.log('å·²ä¿å­˜åˆ°æœ¬åœ°Storage');
            } catch(e) {
                console.error('ä¿å­˜å¤±è´¥:', e);
            }
        }
        
        function renderDialogueList() {
            var list = document.getElementById('dialogueList');
            list.innerHTML = '';
            
            // æ·»åŠ æ‹–æ‹½æŒ‡ç¤ºå™¨
            var indicator = document.createElement('div');
            indicator.className = 'drag-indicator';
            indicator.id = 'dragIndicator';
            list.appendChild(indicator);
            
            dialogues.forEach(function(d, i) {
                var item = document.createElement('div');
                item.className = 'dialogue-item ' + (i === curIdx ? 'active' : '');
                item.draggable = true;
                item.dataset.index = i;
                
                // æ˜¾ç¤ºæ›´å¤šå†…å®¹ï¼Œæ ‡é¢˜æ›´æ¸…æ™°
                var preview = d.lines.map(function(l) { 
                    var speaker = l.speaker || '?';
                    var content = l.content || '';
                    return speaker + ': ' + content.substring(0, 20);
                }).join(' | ');
                if (preview.length > 50) preview = preview.substring(0, 50) + '...';
                
                var annotatedLines = d.lines.filter(function(l) { return l.annotations && (l.annotations.narrative_coherence > 0 || l.annotations.character_consistency > 0); }).length;
                var hasAnno = d.annotation && d.annotation.narrative_coherence > 0;
                var meta = d.lines.length + 'å¥';
                if (annotatedLines > 0) meta += ' â€¢ ' + annotatedLines + '/' + d.lines.length + 'å·²æ ‡æ³¨';
                if (hasAnno) meta += ' â€¢ å·²è¯„åˆ†';
                
                item.innerHTML = '<div class="title">' + (preview || 'ç©ºå¯¹è¯') + '</div>' +
                    '<div class="meta"><span>' + meta + '</span>' +
                    '<button class="delete-btn" onclick="event.stopPropagation();deleteDialogue(' + i + ')" title="åˆ é™¤">ğŸ—‘ï¸</button></div>';
                
                // ç‚¹å‡»é€‰æ‹©
                item.onclick = function() { selectDialogue(parseInt(this.dataset.index)); };
                
                // æ‹–æ‹½äº‹ä»¶
                item.ondragstart = function(e) {
                    this.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', this.dataset.index);
                    setTimeout(() => { this.style.opacity = '0.3'; }, 0);
                };
                item.ondragend = function(e) {
                    this.classList.remove('dragging');
                    this.style.opacity = '';
                    document.querySelectorAll('.dialogue-item').forEach(function(el) { 
                        el.classList.remove('drag-over'); 
                    });
                    document.getElementById('dragIndicator').classList.remove('visible');
                };
                item.ondragover = function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    var dragging = document.querySelector('.dialogue-item.dragging');
                    if (!dragging) return;
                    
                    var fromIdx = parseInt(dragging.dataset.index);
                    var toIdx = parseInt(this.dataset.index);
                    
                    if (fromIdx !== toIdx) {
                        this.classList.add('drag-over');
                        
                        // æ˜¾ç¤ºæŒ‡ç¤ºå™¨
                        var indicator = document.getElementById('dragIndicator');
                        
                        // æŒ‡ç¤ºå™¨å®½åº¦ä¸åˆ—è¡¨é¡¹ä¸€è‡´
                        indicator.style.width = this.offsetWidth + 'px';
                        indicator.style.left = this.offsetLeft + 'px';
                        
                        // åˆ¤æ–­é¼ æ ‡åœ¨ç›®æ ‡çš„ä¸ŠåŠéƒ¨åˆ†è¿˜æ˜¯ä¸‹åŠéƒ¨åˆ†
                        var mouseY = e.clientY;
                        var midY = this.getBoundingClientRect().top + this.getBoundingClientRect().height / 2;
                        
                        if (mouseY < midY) {
                            // æ”¾åœ¨ä¸Šæ–¹
                            indicator.style.top = (this.offsetTop - 2) + 'px';
                        } else {
                            // æ”¾åœ¨ä¸‹æ–¹
                            indicator.style.top = (this.offsetTop + this.offsetHeight) + 'px';
                        }
                        
                        indicator.classList.add('visible');
                    }
                };
                item.ondragleave = function(e) {
                    this.classList.remove('drag-over');
                    if (!this.contains(e.relatedTarget)) {
                        document.getElementById('dragIndicator').classList.remove('visible');
                    }
                };
                item.ondrop = function(e) {
                    e.preventDefault();
                    this.classList.remove('drag-over');
                    document.getElementById('dragIndicator').classList.remove('visible');
                    
                    var fromIdx = parseInt(e.dataTransfer.getData('text/plain'));
                    var toIdx = parseInt(this.dataset.index);
                    
                    if (fromIdx !== toIdx) {
                        var item = dialogues.splice(fromIdx, 1)[0];
                        dialogues.splice(toIdx, 0, item);
                        
                        // è°ƒæ•´ curIdx
                        if (curIdx === fromIdx) curIdx = toIdx;
                        else if (fromIdx < curIdx && toIdx >= curIdx) curIdx--;
                        else if (fromIdx > curIdx && toIdx <= curIdx) curIdx++;
                        
                        renderDialogueList();
                        renderEditor();
                        saveToStorage();
                    }
                };
                
                list.appendChild(item);
            });
        }
        
        function selectDialogue(idx) {
            if (curIdx >= 0 && curMode === 'anno') saveDialogue();
            curIdx = idx;
            selectedLine = -1; // é‡ç½®é€‰ä¸­è¡Œ
            renderDialogueList();
            renderEditor();
        }
        
        function switchMode(mode) {
            if (curIdx < 0) { alert('è¯·å…ˆé€‰æ‹©å¯¹è¯'); return; }
            if (curMode === 'anno' && mode === 'complete') saveDialogue();
            curMode = mode;
            document.getElementById('tabAnno').classList.toggle('active', mode === 'anno');
            document.getElementById('tabComplete').classList.toggle('active', mode === 'complete');
            document.getElementById('annoMode').classList.toggle('hidden', mode !== 'anno');
            document.getElementById('completeMode').classList.toggle('hidden', mode !== 'complete');
            renderEditor(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é€‰ä¸­ä¿¡æ¯
        }
        
        function renderEditor() {
            var empty = document.getElementById('emptyState');
            var card = document.getElementById('editCard');
            if (curIdx < 0) { empty.classList.remove('hidden'); card.classList.add('hidden'); return; }
            empty.classList.add('hidden'); card.classList.remove('hidden');
            
            var d = dialogues[curIdx];
            document.getElementById('dialogueIndex').textContent = curIdx + 1;
            
            var lc = document.getElementById('linesContainer');
            lc.innerHTML = '';
            d.lines.forEach(function(l, lineIdx) {
                var hasAnno = l.annotations && (l.annotations.narrative_coherence > 0 || l.annotations.character_consistency > 0);
                var isSelected = selectedLine === lineIdx;
                var isAi = l.isAiGenerated === true;
                var rowClass = 'line-row';
                if (isSelected) rowClass += ' active';
                if (isAi) rowClass += ' ai-generated';
                
                var row = document.createElement('div');
                row.className = rowClass;
                row.setAttribute('data-idx', lineIdx);
                
                // è¡Œå·æ ·å¼ï¼ˆAIæ ‡è®°ç”¨å°åœ†ç‚¹ï¼‰
                var lineNumClass = 'line-num ' + (hasAnno ? 'annotated' : '') + (isSelected ? ' selected' : '') + (isAi ? ' ai-mark' : '');
                var lineNumTitle = isAi ? 'AIç”Ÿæˆ - ' + (l.aiModel || 'æœªçŸ¥') : '';
                var lineNumContent = '<span class="ai-tooltip" data-ai-model="' + (l.aiModel || '') + '">' + (lineIdx+1) + '</span>';
                
                row.innerHTML = '<span class="' + lineNumClass + '"' + (lineNumTitle ? ' title="' + lineNumTitle + '"' : '') + '>' + lineNumContent + '</span>' +
                    '<div class="line-inputs">' +
                    '<input class="speaker" value="' + esc(l.speaker) + '" placeholder="è§’è‰²" onchange="updateLine(' + lineIdx + ',0,this.value)">' +
                    '<input class="content" value="' + esc(l.content) + '" placeholder="å°è¯" onchange="updateLine(' + lineIdx + ',1,this.value)">' +
                    '</div>' +
                    '<div class="line-actions">' +
                    '<button class="line-btn" onclick="openLineAnnotation(' + lineIdx + ')" title="æ ‡æ³¨æ­¤å¥">ğŸ“</button>' +
                    (isAi ? '<button class="line-btn" onclick="removeAiLine(' + lineIdx + ')" title="åˆ é™¤AIå°è¯" style="color:#9b59b6">âœ•</button>' : '') +
                    '<button class="line-btn remove" onclick="removeLine(' + lineIdx + ')" title="åˆ é™¤">Ã—</button>' +
                    '</div>';
                lc.appendChild(row);
            });
            
            var a = d.annotation || {};
            for (var i = 1; i <= 6; i++) {
                var map = {1:'narrative_coherence',2:'character_consistency',3:'dialogue_naturalness',4:'emotional_expression',5:'game_relevance',6:'length_appropriateness'};
                var sc = a[map[i]] || 0;
                document.querySelectorAll('#sb' + i + ' button').forEach(function(b) { b.classList.toggle('active', parseInt(b.dataset.s) === sc); });
            }
            
            var tags = a.tags || [];
            document.querySelectorAll('#presetTags .preset-tag').forEach(function(t) { t.classList.toggle('active', tags.includes(t.dataset.t)); });
            document.getElementById('suggestionText').value = a.suggestion || '';
            
            if (selectedLine >= 0 && selectedLine < d.lines.length) {
                var l = d.lines[selectedLine];
                document.getElementById('selectedInfo').textContent = '#' + (selectedLine+1) + ' ' + l.speaker + ': ' + l.content.substring(0, 20) + '...';
            } else {
                document.getElementById('selectedInfo').textContent = 'æ— ï¼ˆå°†åœ¨æœ«å°¾ç»­å†™ï¼‰';
            }
        }
        
        function updateLine(idx, field, value) {
            if (curIdx >= 0) {
                dialogues[curIdx].lines[idx][field === 0 ? 'speaker' : 'content'] = value;
                markAsChanged();
            }
        }
        
        function selectLine(idx) {
            selectedLine = idx;
            renderEditor();
        }
        
        function addLine() {
            if (curIdx >= 0) { dialogues[curIdx].lines.push({speaker:'',content:''}); renderEditor(); markAsChanged(); }
        }
        
        function removeLine(idx) {
            if (curIdx >= 0 && dialogues[curIdx].lines.length > 1) { dialogues[curIdx].lines.splice(idx,1); renderEditor(); saveToStorage(); markAsChanged(); }
        }
        
        // åˆ é™¤AIç”Ÿæˆçš„å°è¯ï¼ˆåŒæ—¶æ¸…é™¤AIæ ‡è®°ï¼‰
        function removeAiLine(idx) {
            if (curIdx < 0) return;
            var line = dialogues[curIdx].lines[idx];
            if (line.isAiGenerated) {
                if (confirm('åˆ é™¤è¿™å¥AIç”Ÿæˆçš„å°è¯ï¼Ÿ')) {
                    dialogues[curIdx].lines.splice(idx,1);
                    if (selectedLine >= idx) selectedLine--;
                    renderEditor();
                    saveToStorage();
                    markAsChanged();
                }
            }
        }
        
        // æ¸…é™¤å¯¹è¯ä¸­æ‰€æœ‰AIç”Ÿæˆçš„å°è¯
        function clearAiLines() {
            if (curIdx < 0) return;
            var d = dialogues[curIdx];
            var aiCount = d.lines.filter(function(l) { return l.isAiGenerated; }).length;
            if (aiCount === 0) { alert('å½“å‰å¯¹è¯æ²¡æœ‰AIç”Ÿæˆçš„å°è¯'); return; }
            if (confirm('åˆ é™¤å¯¹è¯ä¸­æ‰€æœ‰ ' + aiCount + ' å¥AIå°è¯ï¼Ÿ')) {
                d.lines = d.lines.filter(function(l) { return !l.isAiGenerated; });
                selectedLine = -1;
                renderEditor();
                saveToStorage();
                markAsChanged();
                alert('å·²åˆ é™¤ ' + aiCount + ' å¥AIå°è¯');
            }
        }
        
        function addDialogue() {
            dialogues.push({ id:'c'+Date.now(), lines:[{speaker:'',content:''},{speaker:'',content:''}], annotation:{narrative_coherence:0,character_consistency:0,dialogue_naturalness:0,emotional_expression:0,game_relevance:0,length_appropriateness:0,tags:[],suggestion:'',created:new Date().toISOString()} });
            selectDialogue(dialogues.length - 1);
            saveToStorage();
            updateStats();
            markAsChanged();
        }
        
        function deleteDialogue(idx) {
            var targetIdx = idx !== undefined ? idx : curIdx;
            if (targetIdx >= 0 && confirm('åˆ é™¤å¯¹è¯ #' + (targetIdx+1) + 'ï¼Ÿ')) {
                dialogues.splice(targetIdx, 1);
                // é€‰æ‹©ç›¸é‚»çš„å¯¹è¯
                if (dialogues.length > 0) {
                    curIdx = targetIdx >= dialogues.length ? dialogues.length - 1 : targetIdx;
                } else {
                    curIdx = -1;
                }
                renderDialogueList(); renderEditor(); saveToStorage(); updateStats();
                clearUnsavedFlag();
            }
        }
        
        function copyDialogue() {
            if (curIdx >= 0) {
                var copy = JSON.parse(JSON.stringify(dialogues[curIdx]));
                copy.id = 'c' + Date.now();
                dialogues.splice(curIdx + 1, 0, copy);
                renderDialogueList(); saveToStorage(); markAsChanged();
            }
        }
        
        function saveDialogue() {
            if (curIdx < 0) return;
            var d = dialogues[curIdx];
            for (var i = 1; i <= 6; i++) {
                var map = {1:'narrative_coherence',2:'character_consistency',3:'dialogue_naturalness',4:'emotional_expression',5:'game_relevance',6:'length_appropriateness'};
                var btn = document.querySelector('#sb' + i + ' button.active');
                d.annotation[map[i]] = btn ? parseInt(btn.dataset.s) : 0;
            }
            var tags = [];
            document.querySelectorAll('#presetTags .preset-tag.active').forEach(function(t) { tags.push(t.dataset.t); });
            d.annotation.tags = tags;
            d.annotation.suggestion = document.getElementById('suggestionText').value;
            d.annotation.updated = new Date().toISOString();
            saveToStorage();
            renderDialogueList();
            updateStats();
            clearUnsavedFlag();
            
            // ä¿å­˜æˆåŠŸåé¦ˆ
            var saveBtn = document.getElementById('saveBtn');
            var originalText = saveBtn.textContent;
            saveBtn.textContent = 'âœ“ å·²ä¿å­˜';
            saveBtn.style.background = '#27ae60';
            setTimeout(function() {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 1500);
        }
        
        function setupScoreButtons() {
            console.log('setupScoreButtons called');
            for (var i = 1; i <= 6; i++) {
                var container = document.getElementById('sb' + i);
                if (!container) { console.log('Container sb' + i + ' not found'); continue; }
                container.innerHTML = '';
                for (var s = 0; s <= 5; s++) {
                    var btn = document.createElement('button');
                    btn.dataset.s = s;
                    btn.textContent = s;
                    btn.onclick = function() {
                        this.parentElement.querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); });
                        this.classList.add('active');
                        updateStats(); // å®æ—¶æ›´æ–°ç»Ÿè®¡
                    };
                    container.appendChild(btn);
                }
            }
            console.log('Score buttons setup complete');
        }
        
        function setupPresetTags() {
            console.log('setupPresetTags called');
            document.querySelectorAll('#presetTags .preset-tag').forEach(function(tag) {
                console.log('Attached handler to tag:', tag.dataset.t);
            });
            document.querySelectorAll('#modalPresetTags .preset-tag').forEach(function(tag) {
                console.log('Attached modal handler to tag:', tag.dataset.t);
            });
        }
        
        // åˆ‡æ¢æ ‡ç­¾çš„é€‰ä¸­çŠ¶æ€ï¼ˆç‚¹å‡»æ ‡ç­¾æœ¬èº«ï¼‰
        function toggleTag(el) {
            el.classList.toggle('active');
            updateStats();
        }
        
        function updateStats() {
            console.log('updateStats called, dialogues:', dialogues.length);
            var total = dialogues.length;
            var done = dialogues.filter(function(d) { return d.annotation && d.annotation.narrative_coherence > 0; }).length;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('doneCount').textContent = done;
            document.getElementById('progressFill').style.width = total > 0 ? (done/total*100) + '%' : '0%';
            
            // ç»Ÿè®¡AIå°è¯
            var aiLineCount = 0;
            dialogues.forEach(function(d) {
                d.lines.forEach(function(l) {
                    if (l.isAiGenerated) aiLineCount++;
                });
            });
            // æ›´æ–°æˆ–æ·»åŠ AIå°è¯ç»Ÿè®¡
            var aiStatItem = document.getElementById('aiLineStat');
            if (aiStatItem) {
                aiStatItem.querySelector('.value').textContent = aiLineCount;
            } else {
                // æ·»åŠ åˆ°ç»Ÿè®¡é¢æ¿
                var statusPanel = document.querySelector('.status-panel');
                var aiSection = document.createElement('div');
                aiSection.className = 'status-section';
                aiSection.id = 'aiLineStat';
                aiSection.innerHTML = '<h4>ğŸ¤– AIå°è¯</h4><div class="stat-item"><span>AIç”Ÿæˆå°è¯</span><span class="value">' + aiLineCount + '</span></div><button class="btn btn-secondary" style="width:100%;margin-top:8px;font-size:0.8rem" onclick="clearAiLines()">æ¸…é™¤æ‰€æœ‰AIå°è¯</button>';
                statusPanel.insertBefore(aiSection, statusPanel.lastElementChild);
            }
            
            renderStatsReport();
        }
        
        function renderStatsReport() {
            var container = document.getElementById('statsContent');
            var scoreNames = {narrative_coherence:'å‰§æƒ…è¿è´¯', character_consistency:'è§’è‰²ä¸€è‡´', dialogue_naturalness:'å°è¯è‡ªç„¶', emotional_expression:'æƒ…æ„Ÿè¡¨è¾¾', game_relevance:'æ¸¸æˆç›¸å…³', length_appropriateness:'é•¿åº¦åˆé€‚'};
            
            // æ”¶é›†æ‰€æœ‰æ ‡æ³¨æ•°æ®ï¼ˆåŒ…å«è¯„åˆ†ä¸º0çš„æƒ…å†µï¼‰
            var allScores = {narrative_coherence:[], character_consistency:[], dialogue_naturalness:[], emotional_expression:[], game_relevance:[], length_appropriateness:[]};
            var allTags = {};
            var annotatedCount = 0;
            
            dialogues.forEach(function(d) {
                var hasAnno = d.annotation && d.annotation.created; // æ£€æŸ¥æ˜¯å¦æœ‰æ ‡æ³¨ï¼ˆé€šè¿‡createdæ—¶é—´æˆ³ï¼‰
                if (hasAnno) {
                    annotatedCount++;
                    Object.keys(scoreNames).forEach(function(key) {
                        if (d.annotation[key] !== undefined) {
                            allScores[key].push(d.annotation[key]);
                        }
                    });
                    if (d.annotation.tags && d.annotation.tags.length > 0) {
                        d.annotation.tags.forEach(function(t) { allTags[t] = (allTags[t] || 0) + 1; });
                    }
                }
                // å•å¥æ ‡æ³¨ä¹Ÿè®¡å…¥
                d.lines.forEach(function(l) {
                    if (l.annotations && l.annotations.created) {
                        Object.keys(scoreNames).forEach(function(key) {
                            if (l.annotations[key] !== undefined) {
                                allScores[key].push(l.annotations[key]);
                            }
                        });
                        if (l.annotations.tags && l.annotations.tags.length > 0) {
                            l.annotations.tags.forEach(function(t) { allTags[t] = (allTags[t] || 0) + 1; });
                        }
                    }
                });
            });
            
            // å¦‚æœæ²¡æœ‰ä»»ä½•æ ‡æ³¨æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
            if (annotatedCount === 0 && Object.keys(allTags).length === 0) {
                var totalScoreCount = 0;
                Object.keys(scoreNames).forEach(function(key) { totalScoreCount += allScores[key].length; });
                if (totalScoreCount === 0) {
                    container.innerHTML = '<div class="no-stats">ğŸ’¡ ç»™å¯¹è¯è¯„åˆ†åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºç»Ÿè®¡æ•°æ®</div>';
                    return;
                }
            }
            
            // è®¡ç®—å¹³å‡åˆ†
            var avgHtml = '<div class="avg-scores">';
            var totalAvg = 0;
            var scoreCount = 0;
            Object.keys(scoreNames).forEach(function(key) {
                var scores = allScores[key];
                if (scores.length > 0) {
                    var avg = scores.reduce(function(a,b){return a+b},0) / scores.length;
                    totalAvg += avg;
                    scoreCount++;
                    var colorClass = avg >= 4 ? 'high' : (avg >= 3 ? 'medium' : 'low');
                    avgHtml += '<div class="avg-score-item"><span class="label">' + scoreNames[key] + '</span><span class="value ' + colorClass + '">' + avg.toFixed(1) + '</span></div>';
                } else {
                    avgHtml += '<div class="avg-score-item"><span class="label">' + scoreNames[key] + '</span><span class="value">-</span></div>';
                }
            });
            avgHtml += '</div>';
            
            if (scoreCount > 0) {
                var overallAvg = totalAvg / scoreCount;
                avgHtml = '<div style="text-align:center;padding:10px;background:#f8f9fa;border-radius:8px;margin-bottom:12px"><span style="font-size:0.9rem;color:#666">ç»¼åˆå¹³å‡åˆ†</span><br><span style="font-size:1.5rem;font-weight:bold;color:' + (overallAvg >= 4 ? '#27ae60' : (overallAvg >= 3 ? '#f39c12' : '#e74c3c')) + '">' + overallAvg.toFixed(1) + '</span></div>' + avgHtml;
            }
            
            // æ ‡ç­¾ç»Ÿè®¡
            var tagHtml = '<div class="tag-stats">';
            var sortedTags = Object.keys(allTags).sort(function(a,b){return allTags[b]-allTags[a]});
            if (sortedTags.length > 0) {
                sortedTags.slice(0, 8).forEach(function(t) {
                    tagHtml += '<div class="tag-stat-item"><span class="tag-name">' + t + '</span><span class="tag-count">' + allTags[t] + '</span></div>';
                });
            } else {
                tagHtml += '<div class="no-stats">æš‚æ— æ ‡ç­¾</div>';
            }
            tagHtml += '</div>';
            
            container.innerHTML = avgHtml + tagHtml;
            console.log('renderStatsReport: annotatedCount=' + annotatedCount, 'scores=', allScores);
        }
        
        function togglePanel() { document.getElementById('ollamaPanel').classList.toggle('show'); }
        
        async function testOllama() {
            var url = document.getElementById('ollamaUrl').value;
            try { var r = await fetch(url + '/api/tags'); if (r.ok) alert('è¿æ¥æˆåŠŸ âœ“'); else alert('è¿æ¥å¤±è´¥'); }
            catch(e) { alert('è¿æ¥å¤±è´¥: ' + e.message); }
        }
        
        // Modal drag
        var isDragging = false;
        var dragOffset = { x: 0, y: 0 };
        var modal = document.getElementById('lineModal');
        var modalContent = document.getElementById('modalContent');
        var modalHeader = document.getElementById('modalHeader');
        
        modalHeader.onmousedown = function(e) {
            if (e.target.classList.contains('modal-close')) return;
            isDragging = true;
            dragOffset.x = e.clientX - modalContent.offsetLeft;
            dragOffset.y = e.clientY - modalContent.offsetTop;
            document.body.style.userSelect = 'none';
        };
        
        document.onmousemove = function(e) {
            if (!isDragging) return;
            modalContent.style.left = (e.clientX - dragOffset.x) + 'px';
            modalContent.style.top = (e.clientY - dragOffset.y) + 'px';
            modalContent.style.margin = 0;
        };
        
        document.onmouseup = function() {
            isDragging = false;
            document.body.style.userSelect = '';
        };
        
        function setupModalDrag() {
            modalContent.style.left = '';
            modalContent.style.top = '';
        }
        
        // Line annotation modal
        function openLineAnnotation(idx) {
            selectedLine = idx;
            renderEditor();
            if (curIdx < 0 || selectedLine < 0) { alert('è¯·å…ˆé€‰ä¸­æŸå¥å°è¯'); return; }
            var d = dialogues[curIdx];
            var line = d.lines[selectedLine];
            if (!line) return;
            currentLineAnno = selectedLine;
            document.getElementById('modalLineNum').textContent = selectedLine + 1;
            document.getElementById('modalLinePreview').textContent = (line.speaker || '?') + ': ' + (line.content || 'ï¼ˆç©ºï¼‰');
            if (!line.annotations) line.annotations = {};
            var a = line.annotations;
            for (var i = 1; i <= 6; i++) {
                var map = {1:'narrative_coherence',2:'character_consistency',3:'dialogue_naturalness',4:'emotional_expression',5:'game_relevance',6:'length_appropriateness'};
                var sc = a[map[i]] || 0;
                var container = document.getElementById('lsb' + i);
                container.innerHTML = '';
                for (var s = 0; s <= 5; s++) {
                    var btn = document.createElement('button');
                    btn.dataset.s = s;
                    btn.textContent = s;
                    btn.onclick = function() { this.parentElement.querySelectorAll('button').forEach(function(b) { b.classList.remove('active'); }); this.classList.add('active'); };
                    if (s === sc) btn.classList.add('active');
                    container.appendChild(btn);
                }
            }
            var tags = a.tags || [];
            document.querySelectorAll('#modalPresetTags .preset-tag').forEach(function(t) {
                t.classList.toggle('active', tags.includes(t.dataset.t));
                // ä¸å†è¦†ç›–onclickï¼Œè®©HTMLä¸­ç»‘å®šçš„toggleTagç”Ÿæ•ˆ
            });
            document.getElementById('lineSuggestion').value = a.suggestion || '';
            document.getElementById('lineModal').classList.add('show');
            setupModalDrag();
        }
        
        function closeLineModal() {
            document.getElementById('lineModal').classList.remove('show');
            currentLineAnno = null;
        }
        
        function saveLineAnnotation() {
            if (curIdx < 0 || currentLineAnno === null) return;
            var line = dialogues[curIdx].lines[currentLineAnno];
            if (!line.annotations) line.annotations = {};
            var a = line.annotations;
            for (var i = 1; i <= 6; i++) {
                var map = {1:'narrative_coherence',2:'character_consistency',3:'dialogue_naturalness',4:'emotional_expression',5:'game_relevance',6:'length_appropriateness'};
                var btn = document.querySelector('#lsb' + i + ' button.active');
                a[map[i]] = btn ? parseInt(btn.dataset.s) : 0;
            }
            var tags = [];
            document.querySelectorAll('#modalPresetTags .preset-tag.active').forEach(function(t) { tags.push(t.dataset.t); });
            a.tags = tags;
            a.suggestion = document.getElementById('lineSuggestion').value;
            a.updated = new Date().toISOString();
            a.created = a.created || new Date().toISOString(); // æ ‡è®°å·²æœ‰æ ‡æ³¨
            saveToStorage();
            closeLineModal();
            renderEditor();
            clearUnsavedFlag();
        }
        
        async function aiSuggest() {
            if (curIdx < 0) { alert('è¯·å…ˆé€‰æ‹©å¯¹è¯'); return; }
            var d = dialogues[curIdx];
            var txt = d.lines.map(function(l) { return l.speaker + ': ' + l.content; }).join('\n');
            var prompt = 'ä¸ºä»¥ä¸‹å¯¹è¯è¯„åˆ†å’Œå»ºè®®ï¼š\n\n' + txt + '\n\nè¯·åˆ†æå¯¹è¯çš„ä¼˜ç¼ºç‚¹ï¼Œå¹¶ç»™å‡ºå…·ä½“çš„ä¿®æ”¹å»ºè®®ï¼Œæ§åˆ¶åœ¨200å­—ä»¥å†…ã€‚';
            try {
                var text = await callAi(prompt);
                document.getElementById('suggestionText').value = text.substring(0, 500);
            } catch(e) { alert('AIå¤±è´¥: ' + e.message); }
        }
        
        async function aiComplete() {
            if (curIdx < 0) { alert('è¯·å…ˆé€‰æ‹©å¯¹è¯'); return; }
            var model = document.getElementById('ollamaModel').value;
            var insertCount = parseInt(document.getElementById('insertCount').value) || 1;
            var d = dialogues[curIdx];
            
            // æ„å»ºå®Œæ•´å¯¹è¯æ–‡æœ¬
            var allLines = d.lines.map(function(l, i) { return '[' + (i+1) + '] ' + (l.speaker || '?') + ': ' + l.content; }).join('\n');
            
            // ç¡®å®šæ’å…¥ä½ç½®æè¿°
            var insertDesc = '';
            if (selectedLine >= 0) {
                insertDesc = 'åœ¨ç¬¬ ' + (selectedLine+1) + ' å¥ä¹‹åæ’å…¥ ' + insertCount + ' å¥æ–°å°è¯ï¼Œ';
            } else {
                insertDesc = 'åœ¨æœ«å°¾ç»­å†™ ' + insertCount + ' å¥æ–°å°è¯ï¼Œ';
            }
            
            var prompt = 'ã€å®Œæ•´å¯¹è¯ä¸Šä¸‹æ–‡ã€‘\n' + allLines + '\n\n' +
                'ã€ä»»åŠ¡ã€‘' + insertDesc + 'ä½¿å¯¹è¯è¿è´¯è‡ªç„¶ã€‚\n\n' +
                'ã€è¦æ±‚ã€‘\n' +
                '1. ä»”ç»†é˜…è¯»ä¸Šé¢çš„å®Œæ•´å¯¹è¯ï¼Œç†è§£æ•´ä½“å‰§æƒ…å’Œè§’è‰²\n' +
                '2. æ–°å°è¯è¦ç¬¦åˆå‰é¢æ‰€æœ‰å¥å­çš„é£æ ¼å’Œè§’è‰²æ€§æ ¼\n' +
                '3. æ–°å°è¯æœ«å°¾å¿…é¡»èƒ½è‡ªç„¶è¡”æ¥åé¢çš„å¥å­\n' +
                '4. åªè¾“å‡ºæ–°å°è¯ï¼Œä¸¥æ ¼æŒ‰"è§’è‰²å: å°è¯"æ ¼å¼ï¼Œæ¯å¥ä¸€è¡Œ\n' +
                '5. ä¸è¦è¾“å‡ºä»»ä½•è§£é‡Šæˆ–è¯´æ˜\n\n' +
                'ã€æ–°å°è¯ã€‘';
            
            var resultDiv = document.getElementById('completeResult');
            resultDiv.innerHTML = '<div class="loading-overlay show"><div class="loading-box"><div class="spinner"></div><p>AIç”Ÿæˆä¸­...</p></div></div>';
            try {
                var text = await callAi(prompt);
                console.log('AIåŸå§‹è¾“å‡º:', text);
                console.log('æ–‡æœ¬é•¿åº¦:', text ? text.length : 0);
                
                if (!text || text.trim().length === 0) {
                    resultDiv.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px;color:#721c24">âš ï¸ AIè¿”å›ç©ºå“åº”<br><small>è¯·æ£€æŸ¥APIé…ç½®å’Œç½‘ç»œè¿æ¥</small></div>';
                    return;
                }
                
                var newLines = parseAiOutput(text);
                console.log('è§£æåçš„æ–°å°è¯:', newLines);
                if (newLines.length > 0) {
                    if (newLines.length > insertCount) newLines = newLines.slice(0, insertCount);
                    var insertIdx = selectedLine >= 0 ? selectedLine + 1 : d.lines.length;
                    // æ ‡è®°ä¸ºAIç”Ÿæˆ
                    newLines.forEach(function(l, i) {
                        l.isAiGenerated = true;
                        var apiType = document.getElementById('apiType').value;
                        l.aiModel = apiType + '/' + model;
                        l.aiTimestamp = new Date().toISOString();
                    });
                    newLines.forEach(function(l, i) { d.lines.splice(insertIdx + i, 0, l); });
                    selectedLine = insertIdx + newLines.length - 1;
                    renderEditor();
                    saveToStorage();
                    resultDiv.innerHTML = '<div style="background:#d4edda;padding:15px;border-radius:8px;color:#155724">âœ“ å·²æ’å…¥ ' + newLines.length + ' å¥AIå°è¯ <span style="font-size:0.8rem">ğŸ¤–</span></div>';
                    markAsChanged();
                } else {
                    resultDiv.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px;color:#721c24">âš ï¸ è§£æå¤±è´¥ï¼ˆAIè¾“å‡ºæ ¼å¼ä¸å¯¹ï¼‰<br><small>åŸå§‹è¾“å‡º: ' + esc(text.substring(0, 150)) + '</small><br><small style="color:#666">è¯·ç¡®ä¿è¿”å›æ ¼å¼ä¸º"è§’è‰²: å°è¯"æ¯è¡Œä¸€å¥</small></div>';
                }
            } catch(e) { 
                console.error('AIè¡¥å…¨é”™è¯¯:', e);
                resultDiv.innerHTML = '<div style="background:#f8d7da;padding:15px;border-radius:8px;color:#721c24">âš ï¸ å¤±è´¥: ' + e.message + '<br><small>æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</small></div>'; 
            }
        }
        
        function parseAiOutput(text) {
            var lines = [];
            text = text.replace(/```[\s\S]*?```/g, '').replace(/\*\*/g, '');
            var pattern = /^([^:\n]+):\s*(.+)$/gm;
            var match;
            while ((match = pattern.exec(text)) !== null) {
                var speaker = match[1].trim();
                var content = match[2].trim();
                if (speaker && content && speaker.length < 50) lines.push({speaker:speaker, content:content});
            }
            if (lines.length === 0) {
                text.split('\n').forEach(function(l) {
                    l = l.trim();
                    if (l && l.length > 2) lines.push({speaker:'', content:l});
                });
            }
            return lines;
        }
        
        function exportData() {
            var exp = { dialogues: dialogues, exported: new Date().toISOString(), version:'1.0' };
            var b = new Blob([JSON.stringify(exp,null,2)], {type:'application/json'});
            var a = document.createElement('a');
            a.href = URL.createObjectURL(b);
            a.download = getFileName('dialogue-annotations');
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        function clearAllData() {
            if (confirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿ')) { dialogues = []; curIdx = -1; localStorage.removeItem('d_data'); localStorage.removeItem('d_unsaved'); renderDialogueList(); renderEditor(); updateStats(); hasUnsavedChanges = false; }
        }
        
        var hasUnsavedChanges = false;
        window.onbeforeunload = function(e) {
            if (hasUnsavedChanges) {
                var message = 'æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œæ˜¯å¦å¯¼å‡ºJSONå¤‡ä»½ï¼Ÿ';
                e.returnValue = message;
                return message;
            }
        };
        
        function esc(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        
        // ===== æ–‡ä»¶ä¿å­˜/åŠ è½½ =====
        var DESKTOP_DATA_PATH = 'C:\\Users\\wzt\\Desktop\\DialogueAnnotatorData\\data.json';
        
        function getFileName(prefix) {
            var now = new Date();
            var pad = function(n) { return n < 10 ? '0' + n : n; };
            var timestamp = now.getFullYear() + '-' + pad(now.getMonth()+1) + '-' + pad(now.getDate()) + '-' + pad(now.getHours()) + pad(now.getMinutes()) + pad(now.getSeconds());
            return prefix + '-' + timestamp + '.json';
        }
        
        async function saveToFile() {
            try {
                var data = {
                    dialogues: dialogues,
                    savedAt: new Date().toISOString(),
                    version: '1.0'
                };
                
                var fileName = 'dialogue-data-' + new Date().toISOString().split('T')[0] + '.json';
                
                // å°è¯•ä½¿ç”¨ File System Access API (Chrome)
                if (window.showSaveFilePicker) {
                    var handle = await window.showSaveFilePicker({
                        suggestedName: fileName,
                        types: [{ description: 'JSONæ–‡ä»¶', accept: {'application/json': ['.json']} }]
                    });
                    var writable = await handle.createWritable();
                    await writable.write(JSON.stringify(data, null, 2));
                    await writable.close();
                    alert('âœ“ å·²ä¿å­˜åˆ°: ' + handle.name);
                } else {
                    // å›é€€åˆ°ä¸‹è½½æ–¹å¼
                    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    var url = URL.createObjectURL(blob);
                    var a = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    a.click();
                    URL.revokeObjectURL(a.href);
                    alert('âœ“ æ–‡ä»¶å·²ä¸‹è½½: ' + fileName + '\\n\\nè¯·æ‰‹åŠ¨ä¿å­˜åˆ°:\\næ¡Œé¢\\\\DialogueAnnotatorData\\\\data.json');
                }
            } catch(e) {
                if (e.name !== 'AbortException') {
                    alert('ä¿å­˜å¤±è´¥: ' + e.message);
                }
            }
        }
        
        function loadFromFile(event, mergeMode) {
            try {
                var file = event.target.files[0];
                if (!file) return;
                var reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        var data = JSON.parse(e.target.result);
                        if (data.dialogues) {
                            var incomingDialogues = data.dialogues;
                            
                            if (mergeMode === true && dialogues.length > 0) {
                                // åˆå¹¶æ¨¡å¼
                                var result = mergeDialogues(dialogues, incomingDialogues);
                                dialogues = result.merged;
                                alert('âœ“ åˆå¹¶å®Œæˆï¼\n' + 
                                    '- æ–°å¢å¯¹è¯: ' + result.added + '\n' + 
                                    '- è·³è¿‡é‡å¤: ' + result.skipped + '\n' + 
                                    '- æ€»å¯¹è¯æ•°: ' + dialogues.length);
                            } else {
                                // å®Œå…¨æ›¿æ¢æ¨¡å¼
                                dialogues = incomingDialogues;
                                alert('âœ“ å¯¼å…¥æˆåŠŸï¼Œå…± ' + dialogues.length + ' æ¡å¯¹è¯');
                            }
                            
                            curIdx = -1;
                            renderDialogueList();
                            renderEditor();
                            updateStats();
                            saveToStorage();
                        }
                    } catch(err) {
                        alert('è§£æå¤±è´¥: ' + err.message);
                    }
                };
                reader.readAsText(file);
            } catch(e) {
                alert('è¯»å–å¤±è´¥: ' + e.message);
            }
        }
        
        // åˆå¹¶ä¸¤ä¸ªå¯¹è¯æ•°æ®é›†
        function mergeDialogues(existing, incoming) {
            var added = 0;
            var skipped = 0;
            var existingMap = {};
            
            // ç°æœ‰å¯¹è¯å»ºç«‹ç´¢å¼•
            existing.forEach(function(d) { existingMap[d.id] = d; });
            
            // éå†æ–°æ•°æ®
            incoming.forEach(function(d) {
                if (!d.id) { d.id = 'c' + Date.now() + Math.random().toString(36).substr(2, 9); }
                
                if (existingMap[d.id]) {
                    // å¯¹è¯å·²å­˜åœ¨ï¼Œåˆå¹¶æ ‡æ³¨
                    skipped++;
                    var existingDialogue = existingMap[d.id];
                    
                    // åˆå¹¶è¯„åˆ†ï¼ˆå–å¹³å‡ï¼‰
                    var scoreKeys = ['narrative_coherence', 'character_consistency', 'dialogue_naturalness', 'emotional_expression', 'game_relevance', 'length_appropriateness'];
                    scoreKeys.forEach(function(key) {
                        if (d.annotation && d.annotation[key] > 0) {
                            if (existingDialogue.annotation[key] > 0) {
                                // ä¸¤è€…éƒ½æœ‰è¯„åˆ†ï¼Œå–å¹³å‡
                                existingDialogue.annotation[key] = Math.round((existingDialogue.annotation[key] + d.annotation[key]) / 2);
                            } else {
                                existingDialogue.annotation[key] = d.annotation[key];
                            }
                        }
                    });
                    
                    // åˆå¹¶æ ‡ç­¾
                    if (d.annotation && d.annotation.tags && d.annotation.tags.length > 0) {
                        if (!existingDialogue.annotation.tags) existingDialogue.annotation.tags = [];
                        d.annotation.tags.forEach(function(t) {
                            if (!existingDialogue.annotation.tags.includes(t)) {
                                existingDialogue.annotation.tags.push(t);
                            }
                        });
                    }
                    
                    // åˆå¹¶ä¿®æ”¹å»ºè®®ï¼ˆéƒ½ä¿ç•™ï¼Œç”¨æ¢è¡Œåˆ†éš”ï¼‰
                    if (d.annotation && d.annotation.suggestion && existingDialogue.annotation.suggestion) {
                        if (d.annotation.suggestion !== existingDialogue.annotation.suggestion) {
                            existingDialogue.annotation.suggestion += '\n---\n' + d.annotation.suggestion;
                        }
                    } else if (d.annotation && d.annotation.suggestion) {
                        existingDialogue.annotation.suggestion = d.annotation.suggestion;
                    }
                    
                } else {
                    // æ–°å¯¹è¯
                    existing.push(d);
                    existingMap[d.id] = d;
                    added++;
                }
            });
            
            return { merged: existing, added: added, skipped: skipped };
        }
        
        function autoLoadFromDesktop() {
            // æµè§ˆå™¨æ— æ³•è‡ªåŠ¨è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¯¼å…¥
            // è¿™ä¸ªåŠŸèƒ½éœ€è¦ä½¿ç”¨File System Access APIæˆ–åå°æœåŠ¡
            console.log('è‡ªåŠ¨è¯»å–åŠŸèƒ½éœ€è¦æœ¬åœ°æœåŠ¡å™¨æ”¯æŒï¼Œæˆ–è¯·æ‰‹åŠ¨å¯¼å…¥æ¡Œé¢æ–‡ä»¶');
        }
        
        function markAsChanged() {
            hasUnsavedChanges = true;
            localStorage.setItem('d_unsaved', 'true');
            saveToStorage();
        }
        
        function clearUnsavedFlag() {
            hasUnsavedChanges = false;
            localStorage.removeItem('d_unsaved');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        load();
        
        // Enterå¿«æ·é”®ä¿å­˜
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.altKey) {
                // å¦‚æœå¼¹çª—æ‰“å¼€ï¼ŒEnterä¿å­˜å¹¶å…³é—­å¼¹çª—
                if (document.getElementById('lineModal').classList.contains('show')) {
                    // æ£€æŸ¥æ˜¯å¦åœ¨è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥æ¡†ä¸­
                    if (e.target.id === 'modalCustomTagInput') {
                        e.preventDefault();
                        addModalCustomTag();
                        return;
                    }
                    e.preventDefault();
                    saveLineAnnotation();
                    return;
                }
                // è‡ªå®šä¹‰æ ‡ç­¾è¾“å…¥æ¡†ä¸­æŒ‰Enteræ·»åŠ æ ‡ç­¾
                if (e.target.id === 'customTagInput') {
                    e.preventDefault();
                    addCustomTag();
                    return;
                }
                // æ’é™¤è¾“å…¥æ¡†ä¸­çš„Enterï¼ˆtextareaã€inputï¼‰
                var tag = e.target.tagName.toLowerCase();
                if (tag === 'textarea' || (tag === 'input' && e.target.type !== 'checkbox' && e.target.type !== 'radio')) {
                    return; // è¾“å…¥æ¡†ä¸­çš„Enteræ­£å¸¸è¾“å…¥
                }
                // åœ¨æ ‡æ³¨æ¨¡å¼ä¸‹ï¼ŒEnterä¿å­˜
                if (curMode === 'anno' && curIdx >= 0) {
                    e.preventDefault();
                    saveDialogue();
                }
            }
        });
    </script>
</body>
</html>